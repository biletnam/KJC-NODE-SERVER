{"version":3,"sources":["../../rest_controller/people.js"],"names":["express","require","router","Router","Joi","multer","path","process","cwd","envModule","peopleService","loginUtil","storage","diskStorage","destination","req","file","cb","filename","originalname","indexOf","parsingNameArray","split","extension","length","fieldname","Date","now","upload","get","res","result","findPeople","then","data","send","post","single","console","log","validatePerson","body","error","status","details","message","person","name","picture","role","information","tokenCheckPromise","decoded","isDirector","personObject","PER_NAME","PER_IMG","ROLE","insertPerson","catch","scheme","string","min","required","validate","module","exports"],"mappings":"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","file":"people.js","sourcesContent":["const express = require('express');\r\nconst router = express.Router();\r\nconst Joi = require('joi');\r\nconst multer = require('multer'); // express에 multer모듈 적용 (for 파일업로드)\r\nvar path = process.cwd();\r\nvar envModule = require( path + '/envModule' );\r\nconst peopleService = require('./oraclDBService/peopleService');\r\nconst loginUtil = require('../commonModule/loginUtil');\r\nconst storage = multer.diskStorage({\r\n\tdestination: function(req, file, cb) {\r\n\t\tcb(null,'uploads/people')\r\n\t},\r\n\tfilename: function(req,file,cb) {\r\n\t\tif(file.originalname.indexOf('.') !== -1) {\r\n\t\t\tconst parsingNameArray = file.originalname.split('.');\r\n\t\t\tconst extension = parsingNameArray[parsingNameArray.length - 1];\r\n\t\t\tcb(null, 'people' + file.fieldname + Date.now() + '.' + extension);\r\n\t\t}else {\r\n\t\t\tcb(null, 'people' + file.fieldname + Date.now());\r\n\t\t}\r\n\t}\r\n})\r\nconst upload = multer({ storage: storage});\r\n\r\nrouter.get('/', (req, res) => {\r\n    const result = peopleService.findPeople();\r\n    result.then((data) => {\r\n        res.send(data);\r\n\t})\r\n})\r\nrouter.post('/',upload.single('imageFile'), (req,res) => {\r\n\tconsole.log(req.file.path);\r\n\tconst {error} = validatePerson(req.body);\r\n\tconsole.log(req.body);\r\n\tif(error) {\r\n\t\tres.status(400).send(error.details[0].message);\r\n\t\treturn;\r\n\t}\r\n\tconst person = {name: req.body.name, picture: '', role: req.body.role};\r\n\tif(req.file && req.file.path) {\r\n\t\tperson.picture = req.file.path;\r\n\t}\r\n\tif(req.body.information) {\r\n\t\tperson.information = req.body.information;\r\n\t}\r\n    loginUtil.tokenCheckPromise(req)\r\n        .then((decoded) => {\r\n            const isDirector = decoded.isDirector;\r\n            if(!isDirector) {\r\n                res.status(403).send('no Director');\r\n                return;\r\n            }\r\n            const personObject = {\r\n                PER_NAME: person.name,\r\n                PER_IMG: person.picture,\r\n                ROLE: person.role\r\n            }\r\n            peopleService.insertPerson(personObject)\r\n                .then((data) => {\r\n                    res.send(data);\r\n                })\r\n                .catch((error) => {\r\n                    console.log(error);\r\n                    res.status(400).send('has error');\r\n                });\r\n        }).catch((error) => res.status(403).send(error))\r\n\r\n})\r\nfunction validatePerson(person) {\r\n\tconst scheme = {\r\n\t\tname: Joi.string().min(1).required(),\r\n\t\trole: Joi.string().min(1).required()\r\n\t}\r\n\t//\t\tminAge: Joi.number().required(),\r\n\treturn Joi.validate(person,scheme);\r\n}\r\nmodule.exports = router;"]}