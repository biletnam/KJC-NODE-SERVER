{"version":3,"sources":["../../rest_controller/ticket.js"],"names":["express","require","router","Router","ticketService","bookSeatService","loginUtil","Joi","post","req","res","validateTicket","body","error","status","send","details","message","selectedSchedule","selectedChair","seatNames","map","c","SEAT_NAME","scheduleId","SCHED_ID","tokenCheckPromise","then","decoded","CUST_ID","_c_id","findBookSeatByScheduleIdAndSeatNames","result","TCK_PRICE","reduce","prev","seat","BOOK_PRICE","b","join","ticketObject","BOOK_SEAT_CNT","length","console","log","createTicket","data","catch","get","id","params","findTicketById","delete","checkAndResetTciket","scheme","object","required","array","validate","module","exports"],"mappings":"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","file":"ticket.js","sourcesContent":["const express = require('express');\r\nconst router = express.Router();\r\nconst ticketService = require('./oraclDBService/ticketService');\r\nconst bookSeatService = require('./oraclDBService/bookSeatService');\r\nconst loginUtil = require('../commonModule/loginUtil');\r\nconst Joi = require('joi');\r\n\r\n\r\nrouter.post('/', (req, res) => {\r\n    const {error} = validateTicket(req.body);\r\n    if(error) {\r\n        res.status(400).send(error.details[0].message);\r\n        return;\r\n    }\r\n\r\n    const selectedSchedule = req.body.selectedSchedule;\r\n    const selectedChair = req.body.selectedChair;\r\n    const seatNames = selectedChair.map((c) => c.SEAT_NAME);\r\n    const scheduleId = selectedSchedule.SCHED_ID;\r\n    loginUtil.tokenCheckPromise(req)\r\n        .then((decoded) => {\r\n            const CUST_ID = decoded._c_id;\r\n            bookSeatService.findBookSeatByScheduleIdAndSeatNames(scheduleId, seatNames)\r\n                .then((result) => {\r\n                    const TCK_PRICE = result.reduce((prev, seat) => prev + seat.BOOK_PRICE, 0);\r\n                    const SEAT_NAME = result.map((b) => b.SEAT_NAME).join(',');\r\n                    const ticketObject =  {CUST_ID: CUST_ID, TCK_PRICE: TCK_PRICE,\r\n                        BOOK_SEAT_CNT: result.length, SCHED_ID: scheduleId, SEAT_NAME: SEAT_NAME, seatNames: seatNames};\r\n                        console.log(ticketObject);\r\n                    return ticketService.createTicket(ticketObject);\r\n                })\r\n                .then((data) => {res.send(data)})\r\n                .catch((error) => {res.status(500).send(error)});\r\n        }).catch((error) => {res.status(403).send('login required')});\r\n})\r\n\r\nrouter.get('/:id', (req, res) => {\r\n    const id = req.params.id;\r\n    if(!id) {\r\n        res.status(405).send('no parameter');\r\n        return;\r\n    }\r\n    ticketService.findTicketById(id)\r\n        .then((data) => {res.send(data)})\r\n        .catch((error) => {res.status(500).send(error)});\r\n})\r\n\r\nrouter.delete('/:id', (req,res) => {\r\n    const id = req.params.id;\r\n    if(!id) {\r\n        res.status(405).send('no parameter');\r\n        return;\r\n    }\r\n    ticketService.checkAndResetTciket(id)\r\n        .then((data) => res.send(data))\r\n        .catch((error) => res.status(500).send(error));\r\n})\r\n\r\n\r\nfunction validateTicket(ticketObject) {\r\n    const scheme = {\r\n        selectedSchedule: Joi.object().required(),\r\n        selectedChair: Joi.array().required()\r\n    }\r\n    //\t\tminAge: Joi.number().required(),\r\n    return Joi.validate(ticketObject,scheme);\r\n}\r\nmodule.exports = router;"]}