{"version":3,"sources":["../../rest_controller/login.js"],"names":["express","require","router","Router","jwt","customerService","passwordUtil","loginUtil","commonUtil","get","req","res","token","headers","query","status","json","success","message","p","Promise","resolve","reject","verify","app","err","decoded","console","log","respond","info","id","_id","name","username","onError","error","then","catch","post","body","password","send","findUserById","data","length","user","result","checkPassword","SALT","PASSWORD","getToken","defaultPromiseErrorHandler","tokenRespondForNonUser","customer","getTokenForNonUser","registerNonUserCustomerAndLoginRespond","registerNonUser","USER_NAME","PHONE","phone","nonUserObject","findCustomerByNameAndPhone","IS_USER","removeImportantData","userInformation","important","map","key","tokenCheckPromise","isUser","CUST_ID","_c_id","findUserByCustomerId","module","exports"],"mappings":"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","file":"login.js","sourcesContent":["const express = require('express');\r\nconst router = express.Router();\r\nconst jwt = require('jsonwebtoken');\r\nconst customerService = require('./oraclDBService/customerService');\r\nconst passwordUtil = require('../commonModule/passwordUtil');\r\nconst loginUtil = require('../commonModule/loginUtil');\r\nconst commonUtil = require('../commonModule/commonUtil');\r\n\r\nrouter.get('/check', (req, res) => {\r\n    const token = req.headers['x-access-token'] || req.query.token\r\n    // token does not exist\r\n    if(!token) {\r\n        return res.status(403).json({\r\n            success: false,\r\n            message: 'not logged in'\r\n        })\r\n    }\r\n\r\n    // create a promise that decodes the token\r\n    const p = new Promise(\r\n        (resolve, reject) => {\r\n            jwt.verify(token, req.app.get('jwt-secret'), (err, decoded) => {\r\n                console.log(decoded);\r\n                if(err) reject(err);\r\n                resolve(decoded)\r\n            })\r\n        }\r\n    )\r\n\r\n    // if token is valid, it will respond with its info\r\n    const respond = (token) => {\r\n        res.json({\r\n            success: true,\r\n            info: {\r\n                id: token._id,\r\n                name: token.username\r\n            }\r\n        })\r\n    }\r\n\r\n    // if it has failed to verify, it will return an error message\r\n    const onError = (error) => {\r\n        res.status(403).json({\r\n            success: false,\r\n            message: error.message\r\n        })\r\n    }\r\n\r\n    // process the promise\r\n    p.then(respond).catch(onError)\r\n});\r\n\r\nrouter.post('/', (req, res) => {\r\n        const body = req.body;\r\n        if(!body || !body.id || !body.password) {\r\n            console.log('login bad request');\r\n            res.status(405).send('Bad Request');\r\n            return;\r\n        }\r\n        customerService.findUserById(body.id)\r\n            .then((data) => {\r\n                if(data.length === 0) {\r\n                    res.status(404).send('there is no User of this ID');\r\n                    return;\r\n                }\r\n                const user = data[0];\r\n                console.log(user);\r\n                const result = passwordUtil.checkPassword(body.password, user.SALT, user.PASSWORD);\r\n                if(result) {\r\n                    loginUtil\r\n                        .getToken(user)\r\n                        .then((token) => {\r\n                            res.send({token: token, message: 'loginSuccess'});\r\n                        })\r\n                        .catch(commonUtil.defaultPromiseErrorHandler);\r\n                }else {\r\n                    res.status(400).send('로그인에 실패했습니다.')\r\n                }\r\n            }).catch(commonUtil.defaultPromiseErrorHandler);\r\n    }\r\n);\r\nconst tokenRespondForNonUser = (req, res, customer) => {\r\n    loginUtil.getTokenForNonUser(customer)\r\n        .then((token) => {\r\n            res.send({token: token, message: 'loginSuccess'}); // here send token\r\n        }).catch(commonUtil.defaultPromiseErrorHandler);\r\n}\r\nconst registerNonUserCustomerAndLoginRespond = (req, res) => {\r\n    customerService.registerNonUser({USER_NAME: req.body.name, PHONE: req.body.phone})\r\n        .then((nonUserObject) => {\r\n            customerService.findCustomerByNameAndPhone(nonUserObject.USER_NAME, nonUserObject.PHONE)\r\n                .then((data) => {\r\n                    if(data.length > 0) {\r\n                        tokenRespondForNonUser(req,res, data[0]);\r\n                    }\r\n                }).catch(commonUtil.defaultPromiseErrorHandler);\r\n        }).catch(commonUtil.defaultPromiseErrorHandler);\r\n}\r\nrouter.post('/nonUser', (req,res) => {\r\n    const body = req.body;\r\n    if(!body || !body.name || !body.phone) {\r\n        console.log('login bad request');\r\n        res.status(405).send('Bad Request');\r\n        return;\r\n    }\r\n    let customer;\r\n    customerService.findCustomerByNameAndPhone(body.name, body.phone).then((data) => {\r\n        if(data.length > 0) {\r\n            customer = data[0];\r\n            if(customer.IS_USER === 'Y'){\r\n                res.status(405).send('이미 회원가입이 돼있는 회원입니다.');\r\n            }else {\r\n                tokenRespondForNonUser(req,res, customer);\r\n                return;\r\n            }\r\n        }else {\r\n            registerNonUserCustomerAndLoginRespond(req,res);\r\n            return;\r\n        }\r\n    }).catch(commonUtil.defaultPromiseErrorHandler);\r\n})\r\nconst removeImportantData = (userInformation) => {\r\n    const important = ['CUST_ID', 'SALT', 'PASSWORD'];\r\n    important.map((key) => {\r\n        delete userInformation[key];\r\n    });\r\n    return userInformation;\r\n}\r\nrouter.get('/info', (req,res) => {\r\n    console.log('get Info Request');\r\n    loginUtil.tokenCheckPromise(req)\r\n        .then((decoded) => {\r\n            if(!decoded.isUser) {\r\n                res.status(405).send('this customer is not user');\r\n            }\r\n            const CUST_ID = decoded._c_id;\r\n            customerService.findUserByCustomerId(CUST_ID)\r\n                .then((data) => {\r\n                    if(!data || data.length === 0 ) {\r\n                      res.status(400).send('no User Information');\r\n                      return;\r\n                    }\r\n                    const userInformation = data[0];\r\n                    res.send(removeImportantData(userInformation))\r\n                }).catch(commonUtil.defaultPromiseErrorHandler);\r\n        }).catch(commonUtil.defaultPromiseErrorHandler);\r\n})\r\n\r\nmodule.exports = router;"]}